<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CyberDeck Control</title>
    <style>
        /* BASE */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; overflow: hidden; font-family: 'Segoe UI', monospace; color: #00ff9d; user-select: none; touch-action: none; }

        /* VIDEO */
        #video-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #stream-view { 
            max-width: 100%; max-height: 100%; 
            transition: transform 0.3s ease; 
        }

        /* UI LAYERS */
        #touch-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }

        /* PANELS */
        .hud-panel { pointer-events: auto; padding: 10px; display: flex; gap: 10px; }
        .top-panel { justify-content: space-between; background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%); padding: 15px; }
        .side-panel { position: absolute; right: 0; top: 50%; transform: translateY(-50%); flex-direction: column; padding-right: 10px; pointer-events: auto; }

        /* KEYBOARD DRAWER */
        .bottom-trigger { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); pointer-events: auto; z-index: 30; }
        #keyboard-drawer { position: absolute; bottom: -300px; left: 0; width: 100%; height: 280px; background: rgba(10, 15, 10, 0.95); border-top: 2px solid #00ff9d; border-radius: 20px 20px 0 0; z-index: 40; pointer-events: auto; transition: bottom 0.3s ease-out; display: flex; flex-direction: column; padding: 15px; box-sizing: border-box; backdrop-filter: blur(10px); }
        #keyboard-drawer.open { bottom: 0; }

        /* BUTTONS */
        .btn { background: rgba(0, 30, 20, 0.6); border: 1px solid rgba(0, 255, 157, 0.5); color: #00ff9d; border-radius: 8px; width: 50px; height: 50px; font-size: 14px; font-weight: bold; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px); transition: 0.1s; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .btn:active { background: #00ff9d; color: #000; transform: scale(0.95); }
        .btn-red { border-color: #ff3333; color: #ff3333; }
        .btn-red:active { background: #ff3333; }
        .btn-rot { border-color: #ffff00; color: #ffff00; font-size: 20px; }

        /* KEYBOARD SPECIFIC */
        .kb-row { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
        .kb-btn { flex: 1; height: 40px; font-size: 12px; border-radius: 6px; }
        .kb-input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"] { flex: 1; background: rgba(0,0,0,0.5); border: 1px solid #00ff9d; color: #fff; padding: 10px; border-radius: 6px; outline: none; font-family: monospace; }

        .info-group { display: flex; flex-direction: column; font-size: 10px; text-align: right; }
        .status-dot { width: 8px; height: 8px; background: red; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background: #00ff9d; box-shadow: 0 0 5px #00ff9d; }
        #drag-overlay { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 0, 0.2); border: 1px solid yellow; color: yellow; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: none; pointer-events: none; }
    </style>
</head>
<body>

    <div id="video-layer">
        <img id="stream-view" src="" alt="NO SIGNAL">
    </div>
    
    <div id="touch-layer"></div>

    <div id="ui-layer">
        <div class="hud-panel top-panel">
            <button class="btn btn-red" onclick="post('/system/shutdown')">OFF</button>
            <button class="btn btn-rot" onclick="rotateScreen()">â†»</button>
            <div id="drag-overlay">DRAGGING</div>
            <div class="info-group">
                <div><span id="status-dot" class="status-dot"></span><span id="status-text">OFFLINE</span></div>
                <div style="margin-top:2px;">CPU: <span id="cpu">0%</span> | RAM: <span id="ram">0%</span></div>
            </div>
        </div>

        <div class="hud-panel side-panel">
            <button class="btn" onclick="post('/volume/up')">+</button>
            <button class="btn" style="margin: 10px 0;" onclick="post('/volume/mute')">ðŸ”‡</button>
            <button class="btn" onclick="post('/volume/down')">-</button>
        </div>
        
        <div class="bottom-trigger">
            <button class="btn" onclick="toggleDrawer()" style="width: 60px; height: 40px; border-bottom: 0; border-radius: 10px 10px 0 0;">â–²</button>
        </div>
    </div>

    <div id="keyboard-drawer">
        <div class="kb-input-row">
            <input type="text" id="text-input" placeholder="Type here..." onkeydown="checkEnter(event)">
            <button class="btn kb-btn" style="flex:0 0 50px" onclick="sendText()">SEND</button>
        </div>
        <div class="kb-row">
            <button class="btn kb-btn" onclick="key('backspace')">âŒ« BKSP</button>
            <button class="btn kb-btn" onclick="key('space')">SPACE</button>
            <button class="btn kb-btn" onclick="key('enter')">ENTER â†µ</button>
        </div>
        <div class="kb-row">
            <button class="btn kb-btn" onclick="shortcut('copy')">COPY</button>
            <button class="btn kb-btn" onclick="shortcut('paste')">PASTE</button>
            <button class="btn kb-btn" onclick="shortcut('alt_tab')">ALT+TAB</button>
        </div>
        <div class="kb-row">
            <button class="btn kb-btn" style="border-color: #00aaff; color:#00aaff" onclick="key('win')">WIN âŠž</button>
            <button class="btn kb-btn" onclick="shortcut('win_d')">DESKTOP</button>
            <button class="btn kb-btn btn-red" onclick="toggleDrawer()">â–¼ CLOSE</button>
        </div>
    </div>

    <script>
        const post = (url) => fetch(url, {method: 'POST'}).catch(()=>{});
        const postJson = (url, data) => fetch(url, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
        }).catch(()=>{});

        // --- ROTATION ---
        let rotation = 0;
        function rotateScreen() {
            rotation = (rotation + 90) % 360;
            const img = document.getElementById('stream-view');
            
            // ÐšÑ€ÑƒÑ‚Ð¸Ð¼ ÐºÐ°Ñ€Ñ‚Ð¸Ð½ÐºÑƒ CSS
            img.style.transform = `rotate(${rotation}deg)`;
            
            // Ð•ÑÐ»Ð¸ 90 Ð¸Ð»Ð¸ 270 - Ð¼ÐµÐ½ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€Ñ‹, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑÐºÑ€Ð°Ð½
            if (rotation % 180 !== 0) {
                img.style.width = "auto"; img.style.height = "100vw"; 
                img.style.maxHeight = "none"; img.style.maxWidth = "none";
            } else {
                img.style.width = "100%"; img.style.height = "100%";
                img.style.maxHeight = "100%"; img.style.maxWidth = "100%";
            }
        }

        // --- STREAM & AUTO RECONNECT ---
        function startStream() {
            const img = document.getElementById('stream-view');
            img.src = "/video_feed?t=" + Date.now();
            img.onerror = () => { setTimeout(() => { img.src = "/video_feed?t=" + Date.now(); }, 1000); };
        }
        window.onload = startStream;

        // --- KEYBOARD ---
        function toggleDrawer() { document.getElementById('keyboard-drawer').classList.toggle('open'); }
        function sendText() {
            const input = document.getElementById('text-input');
            if (input.value) { postJson('/keyboard/type', {text: input.value}); input.value = ""; }
        }
        function checkEnter(e) { if (e.key === 'Enter') sendText(); }
        function key(k) { post('/keyboard/key/' + k); }
        function shortcut(s) { post('/keyboard/shortcut/' + s); }

        // --- STATS ---
        setInterval(async () => {
            try {
                const res = await fetch('/api/stats');
                const d = await res.json();
                document.getElementById('cpu').innerText = d.cpu + '%';
                document.getElementById('ram').innerText = d.ram + '%';
            } catch(e){}
        }, 2000);

        // --- WEBSOCKET ---
        const ws = new WebSocket("ws://" + location.host + "/ws/mouse");
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const dragLabel = document.getElementById('drag-overlay');

        ws.onopen = () => { statusText.innerText = "CONNECTED"; statusDot.classList.add('online'); };
        ws.onclose = () => { statusText.innerText = "RETRY..."; statusDot.classList.remove('online'); setTimeout(()=>location.reload(), 2000); };

        let lastX = 0, lastY = 0;
        let lastTouchEnd = 0;
        let isDragging = false;
        let maxFingers = 0;
        const tp = document.getElementById('touch-layer');

        tp.addEventListener('touchstart', (e) => {
            if(document.getElementById('keyboard-drawer').classList.contains('open')) toggleDrawer();
            e.preventDefault();
            const t = e.touches[0];
            maxFingers = e.touches.length; 
            lastX = t.clientX; lastY = t.clientY;
            
            if (maxFingers === 1 && (Date.now() - lastTouchEnd < 250)) {
                isDragging = true; dragLabel.style.display = "block";
                ws.send(JSON.stringify({ type: "drag_start" }));
            }
        }, {passive: false});

        tp.addEventListener('touchmove', (e) => {
            if (e.touches.length > 2) return;
            e.preventDefault();
            const t = e.touches[0];
            const rawDx = t.clientX - lastX; 
            const rawDy = t.clientY - lastY;
            
            let dx = rawDx;
            let dy = rawDy;

            // --- ÐœÐÐ¢Ð•ÐœÐÐ¢Ð˜ÐšÐ ÐŸÐžÐ’ÐžÐ ÐžÐ¢Ð (ÐšÐ¾Ñ€Ñ€ÐµÐºÑ†Ð¸Ñ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð¼Ñ‹ÑˆÐ¸) ---
            if (rotation === 90) {
                // 90Â° Ð¿Ð¾ Ñ‡Ð°ÑÐ¾Ð²Ð¾Ð¹: Ð’Ð²ÐµÑ€Ñ… -> Ð’Ð»ÐµÐ²Ð¾
                dx = rawDy; dy = -rawDx;  
            } else if (rotation === 180) {
                // 180Â°: Ð’Ð²ÐµÑ€Ñ… -> Ð’Ð½Ð¸Ð·
                dx = -rawDx; dy = -rawDy;
            } else if (rotation === 270) {
                // 270Â°: Ð’Ð²ÐµÑ€Ñ… -> Ð’Ð¿Ñ€Ð°Ð²Ð¾
                dx = -rawDy; dy = rawDx;
            }

            if (Math.abs(rawDx) >= 1 || Math.abs(rawDy) >= 1) {
                if (e.touches.length === 1) {
                    ws.send(JSON.stringify({ dx: Math.round(dx), dy: Math.round(dy) }));
                } 
                else if (e.touches.length === 2) {
                    let scrollDy = dy; 
                    ws.send(JSON.stringify({ type: "scroll", dy: Math.round(scrollDy) }));
                }
                lastX = t.clientX; lastY = t.clientY;
            }
        }, {passive: false});

        tp.addEventListener('touchend', (e) => {
            lastTouchEnd = Date.now();
            if (isDragging) {
                isDragging = false; dragLabel.style.display = "none";
                ws.send(JSON.stringify({ type: "drag_end" }));
                return;
            }
            if (!hasMoved) {
                if (maxFingers === 1) ws.send(JSON.stringify({ type: "click" }));
                if (maxFingers === 2) ws.send(JSON.stringify({ type: "right_click" }));
            }
        });
    </script>
</body>
</html>